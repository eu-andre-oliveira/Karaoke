@model Karaoke.Web.Models.AddMusicaViewModel
@{
    ViewData["Title"] = "Adicionar Música";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header-gradient text-center py-4">
                    <i class="bi bi-music-note-beamed display-4 text-white mb-2"></i>
                    <h2 class="text-white mb-0">Adicionar Música</h2>
                    <p class="text-white-50 mb-0">em @Model.PlaylistNome</p>
                </div>
                <div class="card-body p-4">
                    <!-- Busca na Biblioteca -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-search text-primary"></i> Buscar na Biblioteca Compartilhada
                        </label>
                        <input type="text" id="searchBiblioteca" class="form-control form-control-lg" 
                               placeholder="Digite o nome da música ou artista..." autocomplete="off" />
                        <div id="searchResults" class="list-group mt-2" style="display: none;"></div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Clique em uma música para preencher os campos automaticamente
                        </small>
                    </div>

                    <div class="text-center mb-3">
                        <span class="badge bg-secondary">OU preencha manualmente</span>
                    </div>

                    <!-- Formulário Manual -->
                    <form asp-action="AddMusica" method="post" id="addMusicaForm">
                        <input type="hidden" asp-for="PlaylistId" />
                        <input type="hidden" asp-for="PlaylistNome" />
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <div class="mb-3">
                            <label asp-for="Titulo" class="form-label fw-bold">
                                <i class="bi bi-music-note text-danger"></i> @Html.DisplayNameFor(m => m.Titulo)
                            </label>
                            <input asp-for="Titulo" id="tituloInput" class="form-control form-control-lg" placeholder="Ex: Evidências" />
                            <span asp-validation-for="Titulo" class="text-danger small"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Artista" class="form-label fw-bold">
                                    <i class="bi bi-person text-primary"></i> @Html.DisplayNameFor(m => m.Artista)
                                </label>
                                <input asp-for="Artista" id="artistaInput" class="form-control" placeholder="Ex: Chitãozinho & Xororó" />
                                <span asp-validation-for="Artista" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Cantor" class="form-label fw-bold">
                                    <i class="bi bi-person-lines-fill text-success"></i> @Html.DisplayNameFor(m => m.Cantor)
                                </label>
                                <input asp-for="Cantor" id="cantorInput" class="form-control" placeholder="Quem vai cantar?" />
                                <span asp-validation-for="Cantor" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="UrlStreaming" class="form-label fw-bold">
                                <i class="bi bi-link-45deg text-warning"></i> @Html.DisplayNameFor(m => m.UrlStreaming)
                            </label>
                            <input asp-for="UrlStreaming" id="urlInput" class="form-control" placeholder="https://www.youtube.com/watch?v=..." />
                            <span asp-validation-for="UrlStreaming" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ThumbnailUrl" class="form-label fw-bold">
                                <i class="bi bi-image text-info"></i> @Html.DisplayNameFor(m => m.ThumbnailUrl)
                            </label>
                            <input asp-for="ThumbnailUrl" id="thumbnailInput" class="form-control" placeholder="https://..." />
                            <span asp-validation-for="ThumbnailUrl" class="text-danger small"></span>
                        </div>

                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-gradient btn-lg flex-fill">
                                <i class="bi bi-plus-circle"></i> Adicionar Música
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.PlaylistId" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let searchTimeout;
        const searchInput = document.getElementById('searchBiblioteca');
        const searchResults = document.getElementById('searchResults');
        
        // Campos do formulário
        const tituloInput = document.getElementById('tituloInput');
        const artistaInput = document.getElementById('artistaInput');
        const cantorInput = document.getElementById('cantorInput');
        const urlInput = document.getElementById('urlInput');
        const thumbnailInput = document.getElementById('thumbnailInput');

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const term = this.value.trim();

            if (term.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`@Url.Action("SearchMusicaBiblioteca")?term=${encodeURIComponent(term)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            searchResults.innerHTML = '<div class="list-group-item text-muted">Nenhuma música encontrada</div>';
                            searchResults.style.display = 'block';
                            return;
                        }

                        searchResults.innerHTML = '';
                        data.forEach(musica => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${musica.titulo}</strong>
                                        ${musica.artista ? `<br><small class="text-muted">${musica.artista}</small>` : ''}
                                        <br><small class="badge bg-info">${musica.quantidadeUsos} uso(s)</small>
                                    </div>
                                    <i class="bi bi-arrow-right-circle text-success fs-4"></i>
                                </div>
                            `;
                            item.onclick = (e) => {
                                e.preventDefault();
                                preencherFormulario(musica);
                            };
                            searchResults.appendChild(item);
                        });
                        searchResults.style.display = 'block';
                    });
            }, 300);
        });

        function preencherFormulario(musica) {
            // Preenche os campos do formulário
            tituloInput.value = musica.titulo;
            artistaInput.value = musica.artista || '';
            urlInput.value = musica.urlStreaming;
            thumbnailInput.value = musica.thumbnailUrl || '';
            
            // Foca no campo do cantor para o usuário preencher
            cantorInput.focus();
            
            // Esconde os resultados
            searchResults.style.display = 'none';
            searchInput.value = '';
            
            // Scroll suave para o formulário
            document.getElementById('addMusicaForm').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            // Adiciona um efeito visual de destaque
            const formElement = document.getElementById('addMusicaForm');
            formElement.style.transition = 'background-color 0.5s';
            formElement.style.backgroundColor = 'rgba(255, 107, 53, 0.1)';
            setTimeout(() => {
                formElement.style.backgroundColor = 'transparent';
            }, 1000);
        }

        // Esconder resultados ao clicar fora
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Limpar busca ao focar nos campos do formulário
        [tituloInput, artistaInput, urlInput].forEach(input => {
            input.addEventListener('focus', () => {
                searchResults.style.display = 'none';
            });
        });
    </script>
}